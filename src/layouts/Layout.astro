---
import '@styles/global.css';
import '@fontsource-variable/noto-sans-jp';
import { ClientRouter } from 'astro:transitions';
import Header from '@sections/global/Header.astro';
import Footer from '@layouts/Footer.astro';
import WhatsApp from '@components/ui/layout/WhatsApp.astro';
import BotonesMain from '@components/ui/layout/BotonesMain.astro';
import Analytics from '@vercel/analytics/astro';
import SpeedInsights from '@vercel/speed-insights/astro';

interface Props {
	imgLayout: string;
	title: string;
	boolean: boolean;
}

const { imgLayout, title, boolean } = Astro.props;
---

<!doctype html>
<html
	lang="es"
	class="font-primary-font h-full min-h-screen w-screen overflow-x-hidden scroll-smooth bg-cover bg-center"
	id="html"
	style={`background-image: url(${imgLayout})`}
>
	<head>
		<!-- 
      ___           ___                             
     /  /\         /__/\          ___       ___     
    /  /:/         \  \:\        /  /\     /  /\    
   /  /:/           \  \:\      /  /:/    /  /:/    
  /  /:/  ___   ___  \  \:\    /  /:/    /__/::\    
 /__/:/  /  /\ /__/\  \__\:\  /  /::\    \__\/\:\__ 
 \  \:\ /  /:/ \  \:\ /  /:/ /__/:/\:\      \  \:\/\
  \  \:\  /:/   \  \:\  /:/  \__\/  \:\      \__\::/
   \  \:\/:/     \  \:\/:/        \  \:\     /__/:/ 
    \  \::/       \  \::/          \__\/     \__\/  
     \__\/         \__\/                            
    -->
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="language" content="es" />
		<meta name="robots" content="index, follow" />

		<!-- SEO -->
		<title>{title} | Centro Jurídico Internacional</title>
		<meta
			name="description"
			content="Abogados expertos en derecho laboral, comercial y recaudo de cartera. Proteja su empresa legalmente con el respaldo del Centro Jurídico Internacional. Asesoría gratuita inicial."
		/>
		<meta
			name="keywords"
			content="abogados en Colombia, firma de abogados, recaudo de cartera, asesoría legal, servicios jurídicos, bufete de abogados, Centro Jurídico Internacional, CJI, protección legal empresas"
		/>
		<meta name="author" content="Centro Jurídico Internacional" />

		<!-- Open Graph -->
		<meta property="og:type" content="website" />
		<meta property="og:title" content="Centro Jurídico Internacional - Abogados en Colombia" />
		<meta
			property="og:description"
			content="Abogados expertos en derecho y recaudo de cartera. Proteja su empresa legalmente. Consultas jurídicas para empresas y particulares en Colombia."
		/>
		<meta property="og:image" content="/header/logoMainCJI.svg" />
		<meta property="og:url" content="https://centrojuridicointernacional.co/" />
		<meta property="og:site_name" content="Centro Jurídico Internacional" />

		<!-- Twitter Card -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta
			name="twitter:title"
			content="Centro Jurídico Internacional - Abogados y Recaudo de Cartera"
		/>
		<meta
			name="twitter:description"
			content="Firma legal especializada en protección jurídica empresarial y recuperación de cartera en Colombia."
		/>
		<meta name="twitter:image" content="/header/logoMainCJI.svg" />

		<!-- Canonical -->
		<link rel="canonical" href="https://centrojuridicointernacional.co/" />

		<!-- Favicon -->
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />

		{imgLayout && <link rel="preload" as="image" href={imgLayout} fetchpriority="high" />}

		<!-- Astro ViewTransitions -->
		<ClientRouter />
		<Analytics />
		<SpeedInsights />
	</head>

	<body class:list={['h-full w-full overflow-x-hidden', { 'bg-black/30': boolean }]}>
		<Header />
		<slot />
		<WhatsApp />
		<BotonesMain />
		<Footer />
	</body>
</html>

<!-- Mantengo este script externo, no es parte de la funcionalidad de mensajería -->
<script src="@scripts/resizeMainPage.js"></script>

<!-- NUEVO: comunicación con el dominio principal (WordPress) unificada y sin duplicados -->
<script type="module" is:inline>
	const TARGET_ORIGIN = 'https://centrojuridicointernacional.co';

	function getFaviconHref() {
		const link = document.querySelector("link[rel~='icon']");
		return link instanceof HTMLLinkElement ? link.href : (link && link.href) || null;
	}

	function sendPathToParent() {
		try {
			const payload = {
				path: window.location.pathname + window.location.search + window.location.hash,
				title: document.title,
				favicon: getFaviconHref()
			};
			window.parent.postMessage(payload, TARGET_ORIGIN);
		} catch (err) {
			console.warn('No se pudo enviar la ruta al dominio padre:', err);
		}
	}

	// Enviar ruta inicial
	sendPathToParent();

	// Detectar cambios de ruta (mutaciones que cambien la URL en SPA)
	let lastPath = window.location.pathname + window.location.search + window.location.hash;
	const observer = new MutationObserver(() => {
		const newPath = window.location.pathname + window.location.search + window.location.hash;
		if (newPath !== lastPath) {
			lastPath = newPath;
			sendPathToParent();
		}
	});
	observer.observe(document.body, { subtree: true, childList: true });

	// Navegación atrás/adelante
	window.addEventListener('popstate', sendPathToParent);

	// Transiciones de Astro
	document.addEventListener('astro:after-swap', sendPathToParent);
</script>

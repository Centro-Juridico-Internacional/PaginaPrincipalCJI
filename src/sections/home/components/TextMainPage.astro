---
const WORDS = ['P.S.C', 'Prevención', 'Solución', 'Capacitación'];
---

<div
  class="typed-text text-4xl font-bold text-goldColor xs:text-5xl lg:text-6xl"
  data-words={JSON.stringify(WORDS)}
  aria-live="polite"
  aria-atomic="true"
>
  <span class="typed-text__content">{WORDS[0]}</span>
  <span class="typed-text__cursor" aria-hidden="true">|</span>
</div>

<script type="module" is:inline>
  const initTypedText = () => {
    const container = document.currentScript?.previousElementSibling;
    if (!(container instanceof HTMLElement)) {
      return;
    }

    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) {
      container.classList.add('typed-text--static');
      return;
    }

    const words = JSON.parse(container.dataset.words ?? '[]');
    const textEl = container.querySelector('.typed-text__content');
    if (!textEl || !Array.isArray(words) || words.length === 0) {
      return;
    }

    let index = 0;
    let charIndex = 0;
    let deleting = false;
    let timeoutId = 0;

    const TYPE_DELAY = 90;
    const DELETE_DELAY = 60;
    const WORD_PAUSE = 1400;

    const schedule = (delay) => {
      timeoutId = window.setTimeout(tick, delay);
    };

    const tick = () => {
      const currentWord = words[index] ?? '';
      if (deleting) {
        charIndex = Math.max(0, charIndex - 1);
      } else {
        charIndex = Math.min(currentWord.length, charIndex + 1);
      }

      textEl.textContent = currentWord.slice(0, charIndex);

      if (!deleting && charIndex === currentWord.length) {
        deleting = true;
        schedule(WORD_PAUSE);
        return;
      }

      if (deleting && charIndex === 0) {
        deleting = false;
        index = (index + 1) % words.length;
        schedule(TYPE_DELAY);
        return;
      }

      schedule(deleting ? DELETE_DELAY : TYPE_DELAY);
    };

    schedule(TYPE_DELAY);

    const stop = () => {
      window.clearTimeout(timeoutId);
    };

    document.addEventListener('astro:before-swap', stop, { once: true });
    window.addEventListener('pagehide', stop, { once: true });
  };

  initTypedText();

  export {};
</script>

<style>
  .typed-text {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .typed-text__content {
    min-width: 9ch;
    text-align: center;
    white-space: nowrap;
  }

  .typed-text__cursor {
    margin-left: 0.25rem;
    animation: typed-cursor-blink 0.75s steps(1, end) infinite;
  }

  .typed-text--static .typed-text__cursor {
    animation: none;
  }

  @media (min-width: 480px) {
    .typed-text {
      font-size: 3rem;
    }
  }

  @media (min-width: 1024px) {
    .typed-text {
      font-size: 3.75rem;
    }
  }

  @keyframes typed-cursor-blink {
    0%,
    50% {
      opacity: 1;
    }
    51%,
    100% {
      opacity: 0;
    }
  }
</style>
